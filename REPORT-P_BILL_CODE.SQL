WITH TBL_CTA_DESC AS
 (SELECT FFV.FLEX_VALUE AS CUENTA, 
         FFVT.DESCRIPTION AS DESCRIPCION
    FROM FND_FLEX_VALUE_SETS FFVS,
         FND_FLEX_VALUES     FFV,
         FND_FLEX_VALUES_TL  FFVT
   WHERE FFVS.FLEX_VALUE_SET_NAME = 'CNC_CUENTA'
     AND FFVS.FLEX_VALUE_SET_ID = FFV.FLEX_VALUE_SET_ID
     AND FFV.FLEX_VALUE_ID = FFVT.FLEX_VALUE_ID
     AND FFVT.DESCRIPTION <> 'NULL'
     AND FFVT.LANGUAGE = :P_IDIOMA)
     
SELECT GCC.SEGMENT2 AS CUENTA,
       CTA.DESCRIPCION AS NOMBRE_CUENTA,
       GB.PERIOD_NAME AS PERIODO,
       SUM(CASE
             WHEN GL.NAME NOT LIKE '%IFRS%' AND GB.CURRENCY_CODE = 'COP' THEN
              NVL(GB.PERIOD_NET_DR, 0) + NVL(GB.BEGIN_BALANCE_DR, 0) -
              NVL(GB.PERIOD_NET_CR, 0) - NVL(GB.BEGIN_BALANCE_CR, 0)
             ELSE
              0
           END) AS SALDOFINALFISCALCOP,
       SUM(CASE
             WHEN GL.NAME LIKE '%IFRS%' AND GB.CURRENCY_CODE = 'COP' THEN
              NVL(GB.PERIOD_NET_DR, 0) + NVL(GB.BEGIN_BALANCE_DR, 0) -
              NVL(GB.PERIOD_NET_CR, 0) - NVL(GB.BEGIN_BALANCE_CR, 0)
             ELSE
              0
           END) AS SALDOFINALIFRSCOP,
       SUM(CASE
             WHEN GL.NAME NOT LIKE '%IFRS%' AND GB.CURRENCY_CODE = 'USD' THEN
              NVL(GB.PERIOD_NET_DR, 0) + NVL(GB.BEGIN_BALANCE_DR, 0) -
              NVL(GB.PERIOD_NET_CR, 0) - NVL(GB.BEGIN_BALANCE_CR, 0)
             ELSE
              0
           END) AS SALDOFINALFISCALUSD,
       SUM(CASE
             WHEN GL.NAME LIKE '%IFRS%' AND GB.CURRENCY_CODE = 'USD' THEN
              NVL(GB.PERIOD_NET_DR, 0) + NVL(GB.BEGIN_BALANCE_DR, 0) -
              NVL(GB.PERIOD_NET_CR, 0) - NVL(GB.BEGIN_BALANCE_CR, 0)
             ELSE
              0
           END) AS SALDOFINALIFRSUSD
  FROM GL_BALANCES          GB,
       GL_CODE_COMBINATIONS GCC,
       GL_LEDGERS           GL,
       TBL_CTA_DESC         CTA
 WHERE GB.CODE_COMBINATION_ID = GCC.CODE_COMBINATION_ID
   AND GB.LEDGER_ID = GL.LEDGER_ID
   AND GB.CURRENCY_CODE = GL.CURRENCY_CODE
   AND GCC.SEGMENT2 = CTA.CUENTA
   AND GL.LEDGER_ID IN (SELECT LEDGER_ID
                          FROM GL_LEDGER_LE_V
                         WHERE LEGAL_ENTITY_NAME = :P_EMPRESA)
   AND GB.PERIOD_NAME = :P_PERIODO
   AND GCC.SEGMENT5 IN (:P_BILL_CODE)
   AND GB.ACTUAL_FLAG = 'A'
   AND GCC.SUMMARY_FLAG = 'N'
 GROUP BY GCC.SEGMENT2, GB.PERIOD_NAME, CTA.DESCRIPCION
 ORDER BY GCC.SEGMENT2